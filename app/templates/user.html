{% extends "base.html" %}

{% block title %}{{ user.username }}のプロフィール{% endblock %}

{% block content %}
	<section id="profile-card" class="card">
		<h2>{{ user.username }}</h2>
		<p>ステータス: <span id="user-status-display">{{ user.status }}</span></p>
		<p>現在のフォーカスゲージ: <span id="user-gauge-display">{{ user.current_gauge_level }}</span>%</p>
		<p>フォロー数: {{ user.followed.count() }} | フォロワー数: {{ user.followers.count() }}</p>

		{% if user.id != current_user.id %}
			{% if not current_user.is_following(user) %}
				<a href="{{ url_for('main.follow', username=user.username) }}" class="btn btn-primary">フォローする</a>
			{% else %}
				<a href="{{ url_for('main.unfollow', username=user.username) }}" class="btn btn-secondary">フォロー解除</a>
			{% endif %}
		{% endif %}
		{% if user.id == current_user.id %}
		<div class="share-buttons" style="margin-top: 20px;">
			<button id="share-btn" class="btn btn-secondary">プロフィールを共有</button>
			<button id="qr-code-btn" class="btn btn-secondary">QRコードを表示</button>
		</div>
		{% endif %}
	</section>

	<section class="card">
		<h3>参加中のルーム</h3>
		<div class="list-group">
			{% for room in user.joined_rooms %}
				<a href="{{ url_for('main.room', room_id=room.id) }}" class="list-group-item list-group-item-action flex-column align-items-start" style="border: 1px solid var(--border-color); border-radius: var(--border-radius); padding: 15px; margin-bottom: 10px; display: block;">
					<div class="d-flex w-100 justify-content-between">
						<h5 class="mb-1">{{ room.name }}</h5>
						<small>参加者: {{ room.participants.count() }}人</small>
					</div>
					<p class="mb-1">{{ room.description or '説明はありません' }}</p>
					<small>作成者: {{ room.owner.username }}</small>
				</a>
			{% else %}
				<p>参加しているルームはありません。</p>
			{% endfor %}
		</div>
	</section>

	<section class="card">
		<h3>フォロー中 ({{ user.followed.count() }})</h3>
		<div class="list-group">
			{% for followed_user in user.followed %}
				<a href="{{ url_for('main.user', username=followed_user.username) }}" class="list-group-item list-group-item-action" style="display: block; padding: 10px; margin-bottom: 5px; border: 1px solid var(--border-color); border-radius: 8px; text-decoration: none; color: var(--text-color);">{{ followed_user.username }}</a>
			{% else %}
				<p>誰もフォローしていません。</p>
			{% endfor %}
		</div>
	</section>

	<section class="card">
		<h3>フォロワー ({{ user.followers.count() }})</h3>
		<div class="list-group">
			{% for follower in user.followers %}
				<a href="{{ url_for('main.user', username=follower.username) }}" class="list-group-item list-group-item-action" style="display: block; padding: 10px; margin-bottom: 5px; border: 1px solid var(--border-color); border-radius: 8px; text-decoration: none; color: var(--text-color);">{{ follower.username }}</a>
			{% else %}
				<p>フォロワーはいません。</p>
			{% endfor %}
		</div>
	</section>

	<section class="card">
		<h3>{{ user.username }}さんのフォーカス履歴</h3>
		<table class="table">
			<thead>
				<tr>
					<th>タスク名</th>
					<th>フォーカス時間（分）</th>
					<th>日時</th>
				</tr>
			</thead>
			<tbody>
				{% for session in sessions %}
				<tr>
					<td>{{ session.task_name }}</td>
					<td>{{ session.duration_minutes }}</td>
					<td>{{ session.timestamp.strftime('%Y-%m-%d %H:%M') }}</td>
				</tr>
				{% else %}
				<tr>
					<td colspan="3">まだフォーカス履歴がありません。</td>
				</tr>
				{% endfor %}
			</tbody>
		</table>
	</section>

<!-- QR Code Modal -->
<div id="qr-modal" class="modal" style="display: none;">
    <div class="modal-content">
        <span class="close-btn qr-close-btn">&times;</span>
        <h3>あなたのプロフィールQRコード</h3>
        <canvas id="qr-canvas"></canvas>
    </div>
</div>

<!-- Share URL Modal -->
<div id="share-modal" class="modal" style="display: none;">
    <div class="modal-content">
        <span class="close-btn share-close-btn">&times;</span>
        <h3>プロフィールURL</h3>
        <p>以下のURLをコピーして共有してください。</p>
        <input type="text" id="share-url-input" value="" readonly style="width: 100%; padding: 10px; margin-top: 10px; box-sizing: border-box;">
    </div>
</div>

	<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
	<script>
		document.addEventListener('DOMContentLoaded', () => {
			const userStatusDisplay = document.getElementById('user-status-display');
			const userGaugeDisplay = document.getElementById('user-gauge-display');
			const username = "{{ user.username|escape }}"; // 表示しているユーザーのユーザー名

			async function fetchAndUpdateProfileStatus() {
				try {
					const response = await fetch(`/api/user_status/${username}`);
					const data = await response.json();

					if (response.ok) {
						userStatusDisplay.textContent = data.status;
						userGaugeDisplay.textContent = data.gauge_level;

						const profileCard = document.getElementById('profile-card');
						if (data.status === 'フロー状態') {
							profileCard.classList.add('flow-state');
						} else {
							profileCard.classList.remove('flow-state');
						}
					} else {
						console.error('Failed to fetch user status:', data.message);
					}
				} catch (error) {
					console.error('Error fetching user status:', error);
				}
			}

			// ページ読み込み時に一度更新
			fetchAndUpdateProfileStatus();

			// 5秒ごとに更新
			setInterval(fetchAndUpdateProfileStatus, 5000);
		});
	</script>

	<script>
		document.addEventListener('DOMContentLoaded', () => {
			console.log('Share buttons script loaded');
			const shareBtn = document.getElementById('share-btn');
			const qrCodeBtn = document.getElementById('qr-code-btn');

			console.log('Share button:', shareBtn);
			console.log('QR code button:', qrCodeBtn);

			if (shareBtn && qrCodeBtn) {
				console.log('Share and QR code buttons found');
				const qrModal = document.getElementById('qr-modal');
				const shareModal = document.getElementById('share-modal');
				const qrCloseBtn = document.querySelector('.qr-close-btn');
				const shareCloseBtn = document.querySelector('.share-close-btn');
				const qrCanvas = document.getElementById('qr-canvas');
				const shareUrlInput = document.getElementById('share-url-input');

				shareBtn.addEventListener('click', () => {
					console.log('Share button clicked');
					shareUrlInput.value = window.location.href;
					shareModal.style.display = 'block';
				});

				qrCodeBtn.addEventListener('click', () => {
					console.log('QR code button clicked');
					qrModal.style.display = 'block';
					QRCode.toCanvas(qrCanvas, window.location.href, { width: 256 }, (error) => {
						if (error) console.error(error);
					});
				});

				qrCloseBtn.addEventListener('click', () => {
					qrModal.style.display = 'none';
				});

				shareCloseBtn.addEventListener('click', () => {
					shareModal.style.display = 'none';
				});

				window.addEventListener('click', (event) => {
					if (event.target === qrModal) {
						qrModal.style.display = 'none';
					}
					if (event.target === shareModal) {
						shareModal.style.display = 'none';
					}
				});
			}
		});
	</script>
{% endblock %}