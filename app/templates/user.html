{% extends "base.html" %}

{% block title %}{{ user.username }}のプロフィール{% endblock %}

{% block content %}
	<section id="profile-card" class="card {% if user.status == 'フロー状態' %}flow-state{% endif %}">
		<h2>{{ user.username }}</h2>
		<p>ステータス: <span id="user-status-display">{{ user.status }}</span></p>
		<p>現在のフォーカスゲージ: <span id="user-gauge-display">{{ user.current_gauge_level }}</span>%</p>
		<p>フォロー数: {{ user.followed.count() }} | フォロワー数: {{ user.followers.count() }}</p>

		{% if user.id != current_user.id %}
			{% if not current_user.is_following(user) %}
				<a href="{{ url_for('main.follow', username=user.username) }}" class="btn btn-primary">フォローする</a>
			{% else %}
				<a href="{{ url_for('main.unfollow', username=user.username) }}" class="btn btn-secondary">フォロー解除</a>
			{% endif %}
		{% endif %}
		{% if user.id == current_user.id %}
		<div class="share-buttons" style="margin-top: 20px;">
			<button id="share-btn" class="btn btn-secondary">プロフィールを共有</button>
			<button id="qr-code-btn" class="btn btn-secondary">QRコードを表示</button>
		</div>
		{% endif %}
	</section>

	<section class="card">
		<h3>{{ user.username }}さんのフォーカス履歴</h3>
		<table class="table">
			<thead>
				<tr>
					<th>タスク名</th>
					<th>フォーカス時間（分）</th>
					<th>日時</th>
				</tr>
			</thead>
			<tbody>
				{% for session in sessions %}
				<tr>
					<td>{{ session.task_name }}</td>
					<td>{{ session.duration_minutes }}</td>
					<td>{{ session.timestamp.strftime('%Y-%m-%d %H:%M') }}</td>
				</tr>
				{% else %}
				<tr>
					<td colspan="3">まだフォーカス履歴がありません。</td>
				</tr>
				{% endfor %}
			</tbody>
		</table>
	</section>

<!-- QR Code Modal -->
<div id="qr-modal" class="modal" style="display: none;">
    <div class="modal-content">
        <span class="close-btn">&times;</span>
        <h3>あなたのプロフィールQRコード</h3>
        <canvas id="qr-canvas"></canvas>
    </div>
</div>

	<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
	<script>
		document.addEventListener('DOMContentLoaded', () => {
			const userStatusDisplay = document.getElementById('user-status-display');
			const userGaugeDisplay = document.getElementById('user-gauge-display');
			const username = "{{ user.username|escape }}"; // 表示しているユーザーのユーザー名

			async function fetchAndUpdateProfileStatus() {
				try {
					const response = await fetch(`/api/user_status/${username}`);
					const data = await response.json();

					if (response.ok) {
						userStatusDisplay.textContent = data.status;
						userGaugeDisplay.textContent = data.gauge_level;

						const profileCard = document.getElementById('profile-card');
						if (data.status === 'フロー状態') {
							profileCard.classList.add('flow-state');
						} else {
							profileCard.classList.remove('flow-state');
						}
					} else {
						console.error('Failed to fetch user status:', data.message);
					}
				} catch (error) {
					console.error('Error fetching user status:', error);
				}
			}

			// ページ読み込み時に一度更新
			fetchAndUpdateProfileStatus();

			// 5秒ごとに更新
			setInterval(fetchAndUpdateProfileStatus, 5000);
		});
	</script>

	<script>
		document.addEventListener('DOMContentLoaded', () => {
			console.log('Share buttons script loaded');
			const shareBtn = document.getElementById('share-btn');
			const qrCodeBtn = document.getElementById('qr-code-btn');

			console.log('Share button:', shareBtn);
			console.log('QR code button:', qrCodeBtn);

			if (shareBtn && qrCodeBtn) {
				console.log('Share and QR code buttons found');
				const qrModal = document.getElementById('qr-modal');
				const closeBtn = document.querySelector('.close-btn');
				const qrCanvas = document.getElementById('qr-canvas');

				shareBtn.addEventListener('click', () => {
					console.log('Share button clicked');
					navigator.clipboard.writeText(window.location.href).then(() => {
						alert('プロフィールURLをクリップボードにコピーしました。');
					}, () => {
						alert('URLのコピーに失敗しました。');
					});
				});

				qrCodeBtn.addEventListener('click', () => {
					console.log('QR code button clicked');
					qrModal.style.display = 'block';
					QRCode.toCanvas(qrCanvas, window.location.href, { width: 256 }, (error) => {
						if (error) console.error(error);
					});
				});

				closeBtn.addEventListener('click', () => {
					qrModal.style.display = 'none';
				});

				window.addEventListener('click', (event) => {
					if (event.target === qrModal) {
						qrModal.style.display = 'none';
					}
				});
			}
		});
	</script>
{% endblock %}