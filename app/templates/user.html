{% extends "base.html" %}

{% block title %}{{ user.username }}のプロフィール{% endblock %}

{% block content %}
	<section class="card">
		<h2>{{ user.username }}</h2>
		<p>ステータス: <span id="user-status-display">{{ user.status }}</span></p>
		<p>現在のフォーカスゲージ: <span id="user-gauge-display">{{ user.current_gauge_level }}</span>%</p>
		<p>フォロー数: {{ user.followed.count() }} | フォロワー数: {{ user.followers.count() }}</p>

		{% if user.id != current_user.id %}
			{% if not current_user.is_following(user) %}
				<a href="{{ url_for('main.follow', username=user.username) }}" class="btn btn-primary">フォローする</a>
			{% else %}
				<a href="{{ url_for('main.unfollow', username=user.username) }}" class="btn btn-secondary">フォロー解除</a>
			{% endif %}
		{% endif %}
	</section>

	<section class="card">
		<h3>{{ user.username }}さんのフォーカス履歴</h3>
		<table class="table">
			<thead>
				<tr>
					<th>タスク名</th>
					<th>フォーカス時間（分）</th>
					<th>日時</th>
				</tr>
			</thead>
			<tbody>
				{% for session in sessions %}
				<tr>
					<td>{{ session.task_name }}</td>
					<td>{{ session.duration_minutes }}</td>
					<td>{{ session.timestamp.strftime('%Y-%m-%d %H:%M') }}</td>
				</tr>
				{% else %}
				<tr>
					<td colspan="3">まだフォーカス履歴がありません。</td>
				</tr>
				{% endfor %}
			</tbody>
		</table>
	</section>

	<script>
		document.addEventListener('DOMContentLoaded', () => {
			const userStatusDisplay = document.getElementById('user-status-display');
			const userGaugeDisplay = document.getElementById('user-gauge-display');
			const username = "{{ user.username|escape }}"; // 表示しているユーザーのユーザー名

			async function fetchAndUpdateProfileStatus() {
				try {
					const response = await fetch(`/api/user_status/${username}`);
					const data = await response.json();

					if (response.ok) {
						userStatusDisplay.textContent = data.status;
						userGaugeDisplay.textContent = data.gauge_level;
					} else {
						console.error('Failed to fetch user status:', data.message);
					}
				} catch (error) {
					console.error('Error fetching user status:', error);
				}
			}

			// ページ読み込み時に一度更新
			fetchAndUpdateProfileStatus();

			// 5秒ごとに更新
			setInterval(fetchAndUpdateProfileStatus, 5000);
		});
	</script>
{% endblock %}