{% extends "base.html" %}

{% block title %}{{ room.name }}{% endblock %}

{% block content %}
<style>
    .progress {
        height: 20px;
        background-color: #3a3a3c;
        border-radius: 10px;
        overflow: hidden;
        margin-top: 5px;
    }

    .progress-bar {
        height: 100%;
        color: white;
        text-align: center;
        line-height: 20px;
        background-color: var(--primary-color);
        transition: width 0.6s ease;
    }

    .participant-card {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        padding: 15px;
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius);
    }
    .participant-info {
        flex-grow: 1;
    }
    .participant-actions {
        margin-left: 15px;
    }
    #chat-messages {
        height: 200px;
        overflow-y: auto;
        border: 1px solid var(--border-color);
        padding: 10px;
        margin-bottom: 10px;
        border-radius: var(--border-radius);
    }
    .chat-message {
        margin-bottom: 5px;
    }
    #chat-form {
        display: flex;
    }
    #chat-input {
        flex-grow: 1;
        margin-right: 10px;
    }
</style>
<div class="card">
    <h2>{{ room.name }}</h2>
    <p>{{ room.description }}</p>

    <div class="share-buttons" style="margin-top: 20px;">
        <button id="share-btn" class="btn btn-secondary">ルームを共有</button>
        <button id="qr-code-btn" class="btn btn-secondary">QRコードを表示</button>
        <a href="{{ url_for('main.leave_room', room_id=room.id) }}" class="btn btn-danger">ルームを脱退する</a>
    </div>

    <hr>
    <h4>参加者</h4>
    <div id="participants-list">
        {% for user in room.participants %}
        <div id="user-{{ user.username }}" class="participant-card">
            <div class="participant-info">
                <strong>{{ user.username }}</strong>
                <p class="mb-0"><small>今週の集中時間: {{ user.weekly_focus_time_in_room }}分</small></p>
                <p class="mb-0">ステータス: <span class="status">{{ user.status }}</span></p>
                <div class="progress">
                    <div class="progress-bar" role="progressbar" data-gauge="{{ user.current_gauge_level }}" aria-valuenow="{{ user.current_gauge_level }}" aria-valuemin="0" aria-valuemax="100">
                        {{ user.current_gauge_level }}%
                    </div>
                </div>
            </div>
            {% if current_user == room.owner and user != room.owner %}
            <div class="participant-actions">
                <a href="#" onclick="confirmKick('{{ url_for('main.kick_user', room_id=room.id, user_id=user.id) }}', '{{ user.username }}')" class="btn btn-danger btn-sm">脱退させる</a>
            </div>
            {% endif %}
        </div>
        {% endfor %}
    </div>
</div>

{% if current_user == room.owner %}
<div class="card mt-4">
    <h4>管理者設定</h4>
    <p>このルームの管理者として、以下の操作が可能です。</p>
    <form id="delete-room-form" action="{{ url_for('main.delete_room_route', room_id=room.id) }}" method="POST" style="display: inline;">
        <button type="button" id="delete-room-btn" class="btn btn-danger">このルームを削除する</button>
    </form>
</div>
{% endif %}

<div class="card mt-4">
    <h4>チャット</h4>
    <div id="chat-messages">
        {% for chat in chat_messages %}
            <p class="chat-message"><strong>{{ chat.user.username }}:</strong> {{ chat.message }}</p>
        {% endfor %}
    </div>
    <form id="chat-form">
        <input type="text" id="chat-input" class="form-control" placeholder="メッセージを入力 (5文字以内)" maxlength="5" autocomplete="off">
        <button type="submit" class="btn btn-primary">送信</button>
    </form>
</div>

<div class="card mt-4">
    <h4>システムメッセージ</h4>
    <div id="messages" style="height: 100px; overflow-y: scroll; border: 1px solid var(--border-color); padding: 10px; border-radius: var(--border-radius);"></div>
</div>

<!-- QR Code Modal -->
<div id="qr-modal" class="modal" style="display: none;">
    <div class="modal-content">
        <span class="close-btn qr-close-btn">&times;</span>
        <h3>ルームのQRコード</h3>
        <canvas id="qr-canvas"></canvas>
    </div>
</div>

<!-- Share URL Modal -->
<div id="share-modal" class="modal" style="display: none;">
    <div class="modal-content">
        <span class="close-btn share-close-btn">&times;</span>
        <h3>ルームのURL</h3>
        <p>以下のURLをコピーして共有してください。</p>
        <input type="text" id="share-url-input" value="" readonly style="width: 100%; padding: 10px; margin-top: 10px; box-sizing: border-box;">
    </div>
</div>

<!-- Socket.IOクライアントライブラリ -->
<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
<!-- QRコード生成ライブラリ -->
<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // ★ 初期ゲージを設定
    document.querySelectorAll('.progress-bar').forEach(bar => {
        const level = bar.getAttribute('data-gauge');
        bar.style.width = `${level}%`;
        bar.textContent = `${level}%`;
    });

    const socket = io();
    const roomId = "{{ room.id }}";

    // --- Socket.IO イベントリスナー ---
    socket.on('connect', () => {
        socket.emit('join', { room_id: roomId });
    });

    socket.on('room_message', (data) => {
        const messages = document.getElementById('messages');
        messages.innerHTML += `<p class="chat-message"><em>${data.msg}</em></p>`;
        messages.scrollTop = messages.scrollHeight;
    });

    socket.on('status_updated', (data) => {
        const userCard = document.getElementById(`user-${data.username}`);
        if (userCard) {
            userCard.querySelector('.status').textContent = data.status;
            const progressBar = userCard.querySelector('.progress-bar');
            progressBar.style.width = `${data.gauge_level}%`;
            progressBar.textContent = `${data.gauge_level}%`;
            progressBar.setAttribute('aria-valuenow', data.gauge_level);
        }
    });

    socket.on('new_chat_message', (data) => {
        const chatMessages = document.getElementById('chat-messages');
        const msgElement = document.createElement('p');
        msgElement.classList.add('chat-message');
        msgElement.innerHTML = `<strong>${data.username}:</strong> ${data.msg}`;
        chatMessages.appendChild(msgElement);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    });

    window.addEventListener('beforeunload', () => {
        socket.emit('leave', { room_id: roomId });
    });

    // --- チャットフォームのロジック ---
    const chatForm = document.getElementById('chat-form');
    const chatInput = document.getElementById('chat-input');
    chatForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const msg = chatInput.value.trim();
        if (msg) {
            socket.emit('room_chat', { room_id: roomId, msg: msg });
            chatInput.value = '';
        }
    });

    // --- 共有ボタンのロジック ---
    const shareBtn = document.getElementById('share-btn');
    const qrCodeBtn = document.getElementById('qr-code-btn');

    if (shareBtn && qrCodeBtn) {
        const qrModal = document.getElementById('qr-modal');
        const shareModal = document.getElementById('share-modal');
        const qrCloseBtn = document.querySelector('.qr-close-btn');
        const shareCloseBtn = document.querySelector('.share-close-btn');
        const qrCanvas = document.getElementById('qr-canvas');
        const shareUrlInput = document.getElementById('share-url-input');

        shareBtn.addEventListener('click', () => {
            shareUrlInput.value = window.location.href;
            shareModal.style.display = 'block';
        });

        qrCodeBtn.addEventListener('click', () => {
            qrModal.style.display = 'block';
            QRCode.toCanvas(qrCanvas, window.location.href, { width: 256 }, (error) => {
                if (error) console.error(error);
            });
        });

        qrCloseBtn.addEventListener('click', () => {
            qrModal.style.display = 'none';
        });

        shareCloseBtn.addEventListener('click', () => {
            shareModal.style.display = 'none';
        });

        window.addEventListener('click', (event) => {
            if (event.target === qrModal) {
                qrModal.style.display = 'none';
            }
            if (event.target === shareModal) {
                shareModal.style.display = 'none';
            }
        });
    }

    // --- 管理者機能のJavaScript ---
    const deleteRoomBtn = document.getElementById('delete-room-btn');
    if (deleteRoomBtn) {
        deleteRoomBtn.addEventListener('click', () => {
            showCustomConfirm('本当にこのルームを削除しますか？この操作は取り消せません。', (confirmed) => {
                if (confirmed) {
                    document.getElementById('delete-room-form').submit();
                }
            });
        });
    }
});

function confirmKick(kickUrl, username) {
    showCustomConfirm(`${username}さんを本当に脱退させますか？`, (confirmed) => {
        if (confirmed) {
            window.location.href = kickUrl;
        }
    });
}
</script>
{% endblock %}
